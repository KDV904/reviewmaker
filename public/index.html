<!DOCTYPE html>
<html
  lang="ko"
  class="bg-white text-slate-900 dark:bg-slate-900 dark:text-slate-100"
>
  <head>
    <meta charset="utf-8" />
    <title>ì›ê³  ì œì‘ ìƒì„±ê¸° âœ¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: "class" };
    </script>
    <!-- SheetJS (ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      .shadow-soft {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      }
      .sticky-th th {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 1;
      }
      .dark .sticky-th th {
        background: #1e293b;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-b from-white to-slate-50 dark:from-slate-900 dark:to-slate-800 text-slate-900 dark:text-slate-100 transition-colors duration-300"
  >
    <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨ ë‹¤í¬ëª¨ë“œ í† ê¸€ -->
    <div class="absolute top-4 right-4">
      <button
        id="dark-toggle"
        class="px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-700 text-sm"
      >
        ğŸŒ / ğŸŒ™
      </button>
    </div>

    <div class="max-w-5xl mx-auto p-6 space-y-10">
      <!-- í—¤ë” -->
      <header class="text-center space-y-3">
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight">
          ì›ê³  ì œì‘ ìƒì„±ê¸° <span>ğŸ“âœ¨</span>
        </h1>
        <p class="text-slate-600 dark:text-slate-300">
          ì œì•ˆì„œ PDFë¥¼ ì—…ë¡œë“œí•˜ê³  ì›í•˜ëŠ” ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ë©´<br />
          <b>ìì—°ìŠ¤ëŸ¬ìš´ ë¦¬ë·°/ì›ê³ </b>ë¥¼ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤ ğŸš€
        </p>
      </header>

      <!-- ì•ˆë‚´ ì„¹ì…˜ -->
      <section class="grid md:grid-cols-3 gap-5">
        <div
          class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-5 space-y-2"
        >
          <div
            class="flex items-center gap-2 text-indigo-600 font-semibold text-lg dark:text-indigo-400"
          >
            âœ… <span>ì‚¬ìš© ë°©ë²•</span>
          </div>
          <p class="text-sm text-slate-600 dark:text-slate-300 leading-6">
            ğŸ“ ì œì•ˆì„œ <b>PDF íŒŒì¼</b> ì—…ë¡œë“œ<br />
            âœï¸ ì›í•˜ëŠ” <b>ì›ê³  ì œì‘ ìˆ˜ëŸ‰</b> ì…ë ¥<br />
            ğŸš€ <b>ì œì‘ ì‹œì‘í•˜ê¸°</b> ë²„íŠ¼ í´ë¦­
          </p>
        </div>
        <div
          class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-5 space-y-2"
        >
          <div
            class="flex items-center gap-2 text-emerald-600 font-semibold text-lg dark:text-emerald-400"
          >
            ğŸ“‹ <span>ì¶œë ¥ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</span>
          </div>
          <p class="text-sm text-slate-600 dark:text-slate-300 leading-6">
            ğŸ‘€ ìƒì„±ëœ ì›ê³ ë¥¼ <b>í‘œ</b>ë¡œ í™•ì¸<br />
            â˜‘ï¸ ì–´ìƒ‰í•œ ì›ê³ ëŠ” <b>ì²´í¬ë°•ìŠ¤ ì„ íƒ</b><br />
            â™»ï¸ ì„ íƒí•œ ì›ê³ ë§Œ <b>ë¶€ë¶„ ì¬ìƒì„±</b>
          </p>
        </div>
        <div
          class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-5 space-y-2"
        >
          <div
            class="flex items-center gap-2 text-pink-600 font-semibold text-lg dark:text-pink-400"
          >
            ğŸ“Œ <span>ì°¸ê³ </span>
          </div>
          <ul
            class="text-sm text-slate-600 dark:text-slate-300 leading-6 list-disc pl-4"
          >
            <li>âŒ ëë§ºìŒ ì´ì¤‘í‘œí˜„ ìë™ ì°¨ë‹¨</li>
            <li>âœ¨ <b>ë¶€ë¶„ ì¬ìƒì„±</b>ìœ¼ë¡œ í•„ìš”í•œ í–‰ë§Œ êµì²´ ê°€ëŠ¥</li>
            <li>â¬‡ï¸ ìµœì¢… í™•ì •ë³¸ì€ <b>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</b> ì§€ì›</li>
          </ul>
        </div>
      </section>

      <!-- ì…ë ¥ í¼ -->
      <section
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6 space-y-5"
      >
        <h2 class="text-lg font-semibold">ì…ë ¥ ğŸ“‚</h2>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-2">
            <label
              for="pdf"
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >ì œì•ˆì„œ PDF ì—…ë¡œë“œ</label
            >
            <input
              id="pdf"
              type="file"
              accept="application/pdf"
              class="w-full rounded-xl border border-slate-300 dark:border-slate-600 p-2 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
          </div>
          <div>
            <label
              for="count"
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1"
              >ì›ê³  ì œì‘ ìˆ˜ëŸ‰</label
            >
            <input
              id="count"
              type="number"
              min="1"
              max="200"
              value="30"
              class="w-full rounded-xl border border-slate-300 dark:border-slate-600 p-2 text-right bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3 pt-2">
          <button
            id="btn-generate"
            class="px-5 py-2.5 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-500"
          >
            ì œì‘ ì‹œì‘í•˜ê¸° ğŸš€
          </button>
          <button
            id="btn-fix-selected"
            class="px-5 py-2.5 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-500 hidden"
          >
            ì„ íƒí•œ ë²ˆí˜¸ë§Œ ìˆ˜ì •í•˜ê¸° â™»ï¸
          </button>
          <button
            id="btn-export"
            class="px-5 py-2.5 rounded-xl bg-slate-900 text-white font-medium hover:bg-slate-800 hidden"
          >
            ì—‘ì…€ë¡œ ì¶”ì¶œí•˜ê¸° â¬‡ï¸
          </button>
          <span
            id="status"
            class="text-sm text-slate-500 dark:text-slate-400"
          ></span>
        </div>
      </section>

      <!-- ì²˜ë¦¬ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
      <section
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft p-6 space-y-4"
      >
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">ì²˜ë¦¬ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° ğŸ‘€</h2>
          <span class="text-xs text-slate-500 dark:text-slate-400"
            >ì²´í¬ë°•ìŠ¤ë¡œ ì–´ìƒ‰í•œ ë²ˆí˜¸ë§Œ ì„ íƒí•˜ì„¸ìš”</span
          >
        </div>
        <div class="border rounded-xl overflow-hidden dark:border-slate-600">
          <div class="max-h-[60vh] overflow-auto">
            <table class="min-w-full text-sm sticky-th">
              <thead>
                <tr>
                  <th class="border-b p-2 w-14 text-center">ì„ íƒ</th>
                  <th class="border-b p-2 w-16 text-center">ë²ˆí˜¸</th>
                  <th class="border-b p-2 text-left">ë¦¬ë·° / ì›ê³  ë‚´ìš©</th>
                </tr>
              </thead>
              <tbody id="preview-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- í‘¸í„° -->
      <footer
        class="py-6 text-center text-xs text-slate-500 dark:text-slate-400"
      >
        â“˜ ìë™ ìƒì„±ëœ ì›ê³ ëŠ” ì—…ë¡œë“œ ì „ ë°˜ë“œì‹œ ê²€ìˆ˜í•˜ì„¸ìš”. ì–´ìƒ‰í•œ ëë§ºìŒì€
        ì„œë²„ì—ì„œ ìë™ êµì •ë©ë‹ˆë‹¤.
      </footer>
    </div>

    <!-- ê¸°ëŠ¥ ë¡œì§ -->
    <script>
      const elPdf = document.getElementById("pdf");
      const elCount = document.getElementById("count");
      const btnGen = document.getElementById("btn-generate");
      const btnFix = document.getElementById("btn-fix-selected");
      const btnExcel = document.getElementById("btn-export");
      const statusEl = document.getElementById("status");
      const tbody = document.getElementById("preview-body");
      const btnDark = document.getElementById("dark-toggle");

      let summaryCache = "";
      let reviews = [];

      const show = (el) => el.classList.remove("hidden");
      const hide = (el) => el.classList.add("hidden");
      const setStatus = (msg) => (statusEl.textContent = msg || "");
      const anyChecked = () =>
        [...tbody.querySelectorAll(".row-check:checked")].length > 0;

      function renderRows() {
        tbody.innerHTML = "";
        reviews.forEach((text, i) => {
          const tr = document.createElement("tr");
          tr.className =
            i % 2 ? "" : "odd:bg-slate-50 dark:odd:bg-slate-700/50";
          tr.innerHTML = `
          <td class="border-b p-2 text-center"><input type="checkbox" class="row-check" data-idx="${i}"></td>
          <td class="border-b p-2 text-center">${i + 1}</td>
          <td class="border-b p-2"><div class="whitespace-pre-wrap">${escapeHtml(
            text
          )}</div></td>
        `;
          tbody.appendChild(tr);
        });
        wireCheckboxToggle();
        updateActionButtons();
      }

      function wireCheckboxToggle() {
        tbody.querySelectorAll(".row-check").forEach((chk) => {
          chk.addEventListener("change", updateActionButtons);
        });
      }

      function updateActionButtons() {
        if (anyChecked()) {
          show(btnFix);
          hide(btnExcel);
        } else {
          hide(btnFix);
          show(btnExcel);
        }
      }

      function escapeHtml(s) {
        return (s ?? "").replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );
      }

      // PDF ì—…ë¡œë“œ â†’ ë¦¬ë·° ìƒì„±
      async function onGenerate() {
        const file = elPdf.files[0];
        const n = Number(elCount.value || 30);
        if (!file) return alert("PDF íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        if (!n || n < 1) return alert("ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

        setStatus("ìƒì„± ì¤‘â€¦");
        try {
          const fd = new FormData();
          fd.append("file", file);
          fd.append("n", String(n));

          const res = await fetch("/api/generate-from-file", {
            method: "POST",
            body: fd,
          });
          const data = await res.json();
          if (data.error) throw new Error(data.error);

          summaryCache = data.summary || "";
          reviews = data.reviews || [];
          renderRows();
          setStatus(`ì™„ë£Œ: ${reviews.length}ê°œ ìƒì„±`);
        } catch (e) {
          console.error(e);
          setStatus("ìƒì„± ì‹¤íŒ¨");
          alert("ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì„ íƒ í–‰ë§Œ ì¬ìƒì„±
      async function onFixSelected() {
        const checked = [...tbody.querySelectorAll(".row-check:checked")].map(
          (x) => Number(x.dataset.idx)
        );
        if (checked.length === 0) return;
        if (summaryCache == null) return alert("ë¨¼ì € PDFë¡œ ìƒì„±í•´ ì£¼ì„¸ìš”.");

        setStatus(`ì„ íƒ ${checked.length}ê°œ ì¬ìƒì„± ì¤‘â€¦`);
        try {
          const res = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ summary: summaryCache, n: checked.length }),
          });
          const data = await res.json();
          if (data.error) throw new Error(data.error);

          const newOnes = data.reviews || [];
          checked.forEach((idx, i) => {
            reviews[idx] = newOnes[i] || reviews[idx];
          });
          renderRows();
          setStatus(`ì™„ë£Œ: ${checked.length}ê°œ êµì²´`);
        } catch (e) {
          console.error(e);
          setStatus("ì¬ìƒì„± ì‹¤íŒ¨");
          alert("ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì—‘ì…€ ì¶”ì¶œ
      function onExportExcel() {
        if (!reviews.length) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const rows = reviews.map((r, i) => ({ ë²ˆí˜¸: i + 1, ë¦¬ë·°: r }));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, "ë¦¬ë·°");
        XLSX.writeFile(wb, "ë¦¬ë·°_ìë™ìƒì„±.xlsx");
      }

      // ë‹¤í¬ëª¨ë“œ í† ê¸€
      function applyDarkMode(enabled) {
        if (enabled) document.documentElement.classList.add("dark");
        else document.documentElement.classList.remove("dark");
        localStorage.setItem("darkmode", enabled ? "1" : "0");
      }
      btnDark.addEventListener("click", () => {
        applyDarkMode(!document.documentElement.classList.contains("dark"));
      });
      if (localStorage.getItem("darkmode") === "1") {
        applyDarkMode(true);
      }

      btnGen.addEventListener("click", onGenerate);
      btnFix.addEventListener("click", onFixSelected);
      btnExcel.addEventListener("click", onExportExcel);

      updateActionButtons();
    </script>
  </body>
</html>
